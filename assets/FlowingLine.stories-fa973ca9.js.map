{"version":3,"file":"FlowingLine.stories-fa973ca9.js","sources":["../../packages/FlowingLine/index.ts","../../src/stories/components/flowingLine/index.vue"],"sourcesContent":["import * as THREE from 'three'\nconst createFlowingLine = (curve: any) => {\n  //曲线上等间距返回多个顶点坐标\n  const points = curve.getSpacedPoints(100)\n\n  let index = 20 //取点索引位置\n  const num = 15 //从曲线上获取点数量\n  let points2 = points.slice(index, index + num) //从曲线上获取一段\n  const newPoints2 = new THREE.CatmullRomCurve3(points2).getSpacedPoints(100) //获取更多的点数\n  const geometry2 = new THREE.BufferGeometry()\n  geometry2.setFromPoints(newPoints2)\n  // 每个顶点对应一个百分比数据attributes.percent 用于控制点的渲染大小\n  const percentArr = [] //attributes.percent的数据\n  for (let i = 0; i < newPoints2.length; i++) {\n    percentArr.push(i / newPoints2.length)\n  }\n  const percentAttribue = new THREE.BufferAttribute(new Float32Array(percentArr), 1)\n  geometry2.attributes.percent = percentAttribue\n  // 批量计算所有顶点颜色数据\n  const colorArr = []\n  for (let i = 0; i < newPoints2.length; i++) {\n    const color1 = new THREE.Color(0x006666) //轨迹线颜色 青色\n    const color2 = new THREE.Color(0xffff00) //黄色\n    const color = color1.lerp(color2, i / newPoints2.length)\n    colorArr.push(color.r, color.g, color.b)\n  }\n  // 设置几何体顶点颜色数据\n  geometry2.attributes.color = new THREE.BufferAttribute(new Float32Array(colorArr), 3)\n\n  // 点模型渲染几何体每个顶点\n  const PointsMaterial = new THREE.PointsMaterial({\n    color: 0xffff00,\n    size: 5.0,\n    vertexColors: true\n  })\n  const flyPoints = new THREE.Points(geometry2, PointsMaterial)\n  flyPoints.name = 'flowing-line'\n  // 修改点材质的着色器源码\n  PointsMaterial.onBeforeCompile = function (shader: any) {\n    // 顶点着色器中声明一个attribute变量:百分比\n    shader.vertexShader = shader.vertexShader.replace(\n      'uniform float scale;',\n      ['uniform float scale;', 'attribute float percent;'].join('\\n')\n    )\n    // 调整点渲染大小计算方式\n    shader.vertexShader = shader.vertexShader.replace(\n      'gl_PointSize = size',\n      ['gl_PointSize = percent * size'].join('\\n') // .join()把数组元素合成字符串\n    )\n  }\n  // 飞线动画\n  const indexMax = points.length - num //飞线取点索引范围\n  function animation() {\n    if (index > indexMax) index = 0\n    index += 1\n    points2 = points.slice(index, index + num) //从曲线上获取一段\n    const curve = new THREE.CatmullRomCurve3(points2)\n    const newPoints2 = curve.getSpacedPoints(100) //获取更多的点数\n    geometry2.setFromPoints(newPoints2)\n\n    requestAnimationFrame(animation)\n  }\n  animation()\n\n  return flyPoints\n}\n\nexport { createFlowingLine }\n","<template>\n  <div id=\"FlowingLine\"></div>\n</template>\n\n<script setup lang=\"ts\">\nimport * as THREE from 'three'\nimport { onMounted, onBeforeUpdate, onBeforeMount } from 'vue';\nimport { scene, renderer, camera } from '../basic/three'\n// import { controls } from '../basic/controls'\nimport { createFlowingLine } from '../../../../packages/index'\n\n// const props = defineProps({\n//   size: {\n//     type: Number,\n//     default: 20,\n//     required: false\n//   },\n//   color: {\n//     type: String,\n//     default: '#15de1d',\n//     required: false\n//   }\n// })\n\nlet timer: any = null\n\nonBeforeMount(() => {\n  if (timer) cancelAnimationFrame(timer)\n  scene.remove.apply(scene, scene.children)\n})\n\nonMounted(() => {\n  camera.zoom = 1;\n  const curve = new THREE.CatmullRomCurve3(\n    [\n      new THREE.Vector3(0, 200, 0),\n      new THREE.Vector3(0, -100, 0),\n      new THREE.Vector3(0, -200, 0),\n      new THREE.Vector3(50, -280, 0),\n      new THREE.Vector3(70, -280, 0),\n      new THREE.Vector3(300, -250, 0),\n      new THREE.Vector3(570, -240, 0),\n      new THREE.Vector3(-570, 300, 0),\n      new THREE.Vector3(-300, 300, 0)\n    ],\n    true,\n    'chordal',\n    1.0\n  )\n  const FlowingLine = createFlowingLine(curve)\n  scene.add( FlowingLine );\n\n  const FlowingLineElement = document.getElementById('FlowingLine')\n  if (FlowingLineElement) FlowingLineElement.appendChild(renderer.domElement)\n  const render = () => {\n    renderer.render(scene, camera)\n    camera.updateProjectionMatrix()\n    // controls.update()\n    timer = requestAnimationFrame(render)\n  }\n\n  render()\n})\n\nonBeforeUpdate(() => {\n  console.log('onBeforeUpdate')\n  renderer.clear()\n  scene.remove.apply(scene, scene.children)\n  scene.remove.apply(scene, scene.children)\n  renderer.forceContextLoss()\n  cancelAnimationFrame(timer)\n  const gl = renderer.domElement.getContext('webgl')\n  gl && gl.getExtension('WEBGL_lose_context')?.loseContext()\n})\n</script>"],"names":["createFlowingLine","__name","curve","points","index","num","points2","newPoints2","THREE.CatmullRomCurve3","geometry2","THREE.BufferGeometry","percentArr","i","percentAttribue","THREE.BufferAttribute","colorArr","color1","THREE.Color","color2","color","PointsMaterial","THREE.PointsMaterial","flyPoints","THREE.Points","shader","indexMax","animation","timer","onBeforeMount","scene","onMounted","camera","THREE.Vector3","FlowingLine","FlowingLineElement","renderer","render","onBeforeUpdate","gl","_a"],"mappings":"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"}